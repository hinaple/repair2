<!doctype html>
<html lang="en" spellcheck="false">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>REPAIR2 plugin dev page</title>
        <style>
            body {
                margin: 0;
                display: flex;
                height: 100vh;
                overflow: hidden;
                background: repeating-conic-gradient(#e7e7e7 0% 25%, #bababa 0% 50%) 50% / 16px 16px;
            }
            input[type="text"],
            input[type="number"] {
                width: 100%;
                margin-bottom: 8px;
                padding: 6px 8px;
                border-radius: 4px;
                border: none;
                box-sizing: border-box;
            }
            #props-panel {
                position: fixed;
                top: 10px;
                right: 10px;
                width: 280px;
                max-height: 90vh;
                background: rgba(0, 0, 0, 0.7);
                color: white;
                font-family: sans-serif;
                border-radius: 8px;
                overflow: hidden;
                user-select: none;
                display: flex;
                flex-direction: column;
                z-index: 9999;
                backdrop-filter: blur(3px);
            }
            #props-header {
                padding: 10px;
                cursor: pointer;
                background: rgba(255, 255, 255, 0.1);
                font-weight: bold;
            }
            #props-content {
                padding: 10px;
                overflow-y: auto;
                flex: 1;
            }
            #props-content label {
                display: block;
                font-size: 0.85em;
                margin-bottom: 4px;
            }
            #props-panel.collapsed #props-content {
                display: none;
            }

            #component-container {
                /* outline: solid #000 2px; */
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                background-color: #fff;
            }
        </style>
    </head>
    <body>
        <div id="component-container"></div>
        <div id="props-panel" class="">
            <div id="props-header">Config</div>
            <div id="props-content"></div>
        </div>
        <script type="module">
            import SveltePlugin from "../src/main.js";
            customElements.define("repair-svelte-plugin", SveltePlugin);

            const attributes = SveltePlugin.attributes ?? [];
            const container = document.getElementById("component-container");
            const propsState = {};
            const configs = {
                width: {
                    setter: (val) => {
                        container.style.width = val ? `${val}px` : "auto";
                    },
                    type: "number",
                    placeholder: "auto"
                },
                height: {
                    setter: (val) => {
                        container.style.height = val ? `${val}px` : "auto";
                    },
                    type: "number",
                    placeholder: "auto"
                }
            };
            let pluginInstance = null;
            function createPluginInstance() {
                if (pluginInstance) {
                    container.removeChild(pluginInstance);
                    pluginInstance = null;
                }
                pluginInstance = new SveltePlugin({
                    attributes: { ...propsState },
                    isDev: true
                });
                container.appendChild(pluginInstance);
            }
            const propsPanel = document.getElementById("props-panel");
            const propsHeader = document.getElementById("props-header");
            propsHeader.addEventListener("click", () => {
                propsPanel.classList.toggle("collapsed");
            });
            function createPropInput(key) {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");
                label.textContent = key;
                label.htmlFor = `input-${key}`;
                wrapper.appendChild(label);
                const input = document.createElement("input");
                input.autocomplete = "off";
                input.id = `input-${key}`;
                input.type = "text";
                input.value = propsState[key] ?? "";
                input.placeholder = "null";
                input.addEventListener("input", () => {
                    const val = input.value.trim();
                    if (val === "") {
                        delete propsState[key];
                    } else {
                        propsState[key] = val;
                    }
                    createPluginInstance();
                });
                wrapper.appendChild(input);
                return wrapper;
            }

            function createConfigInput(
                key,
                { setter, type = "text", placeholder = null, defaultValue = null }
            ) {
                const wrapper = document.createElement("div");
                const label = document.createElement("label");
                label.textContent = key;
                label.htmlFor = `config-input-${key}`;
                wrapper.appendChild(label);
                const input = document.createElement("input");
                input.autocomplete = "off";
                input.id = `config-input-${key}`;
                input.type = type;
                input.value = defaultValue;
                if (placeholder) input.placeholder = placeholder;
                input.addEventListener("input", () => {
                    configs[key] = input.value;
                    setter(input.value);
                });
                wrapper.appendChild(input);
                return wrapper;
            }
            function initPropsPanel() {
                const content = document.getElementById("props-content");
                content.innerHTML = "";
                attributes.forEach((key) => {
                    if (key != null) {
                        content.appendChild(createPropInput(key));
                    }
                });
                const hr = document.createElement("hr");
                hr.style.border = "1px solid #444";
                content.appendChild(hr);
                Object.entries(configs).forEach(([key, val]) => {
                    content.appendChild(createConfigInput(key, val));
                });
            }
            initPropsPanel();
            createPluginInstance();
        </script>
    </body>
</html>
